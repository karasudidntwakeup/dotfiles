#!/bin/sh

unset HISTFILE

cleanup() {
    [ -n "$PID" ] && kill -9 "$PID" 2>/dev/null
    [ -n "$TMPDIR" ] && rm -rf "$TMPDIR"
}

trap cleanup INT TERM EXIT

LINK="${1:-$(wl-paste)}"
[ -z "$LINK" ] && { echo "No link provided"; exit 1; }

TMPDIR=$(mktemp -d)

peerflix "$LINK" --path "$TMPDIR" > /dev/null 2>&1 &
PID=$!

echo "Waiting for video..."
for i in $(seq 1 30); do
    VIDEO=$(find "$TMPDIR" -type f -size +1M \( -name "*.mp4" -o -name "*.mkv" -o -name "*.avi" \) 2>/dev/null | head -n 1)
    [ -n "$VIDEO" ] && break
    sleep 2
done

[ -z "$VIDEO" ] && { echo "Timeout"; exit 1; }

echo "Downloading subtitles..."
subliminal download -l ara "$VIDEO" 2>/dev/null

SUB=$(find "$TMPDIR" -name "*.srt" 2>/dev/null | head -n 1)

[ -n "$SUB" ] && mpv --sub-file="$SUB" "$VIDEO" || mpv "$VIDEO"
